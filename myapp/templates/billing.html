{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Billing - Coffee with Aditi</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
<style>
body {
    font-family: 'Poppins', sans-serif;
    background: #1e130c;
    color: #f3e7de;
    padding: 50px;
}
h1 {
    font-family: 'Playfair Display', serif;
    color: #f3e7de;
    text-align: center;
    margin-bottom: 40px;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
}
th, td {
    padding: 12px;
    border-bottom: 1px solid #b67c4b;
    text-align: left;
}
th {
    background: #b67c4b;
    color: #fff;
}
.total {
    font-weight: 600;
    text-align: right;
    font-size: 1.2rem;
    margin-bottom: 30px;
}
button {
    padding: 12px 25px;
    background: #b67c4b;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
}
button:hover {
    background: #d09763;
}
input.qty-input {
    width: 60px;
    padding: 5px;
    text-align: center;
    border-radius: 4px;
    border: 1px solid #b67c4b;
}

/* Address form styling */
.billing-form {
    max-width: 500px;
    margin: 0 auto;
    background: #2b1f16;
    padding: 30px;
    border-radius: 10px;
}
.billing-form input {
    width: 100%;
    padding: 12px 10px;
    margin-bottom: 15px;
    border-radius: 6px;
    border: 1px solid #b67c4b;
    background: #1e130c;
    color: #f3e7de;
}
.billing-form input::placeholder {
    color: #f3e7de99;
}
.billing-form button {
    width: 100%;
}
</style>
</head>
<body>

<h1>Billing Details</h1>

<!-- Billing table -->
<table id="billing-table">
<thead>
<tr>
<th>Item</th>
<th>Quantity</th>
<th>Price</th>
<th>Subtotal</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div class="total" id="billing-total">Total: ₹0.00</div>

<!-- Billing Address form -->
<div class="billing-form">
  <form id="billingForm">
    {% csrf_token %}
    <input type="text" id="name" name="name" placeholder="Full Name" required>
    <input type="email" id="email" name="email" placeholder="Email" required>
    <input type="text" id="phone" name="phone" placeholder="Phone" required>
    <input type="text" id="address" name="address" placeholder="Address" required>
    <button type="submit">Place Order</button>
  </form>
</div>

<script>
let cart = JSON.parse(localStorage.getItem('cart')) || [];

function loadCart(){
    const tbody = document.querySelector('#billing-table tbody');
    tbody.innerHTML = '';
    cart.forEach((item,index)=>{
        let tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.name}</td>
            <td><input type="number" min="1" class="qty-input" value="${item.qty}" data-index="${index}"></td>
            <td>₹${item.price.toFixed(2)}</td>
            <td class="subtotal">₹${(item.price*item.qty).toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
    });
    updateTotal();
    addQuantityListeners();
}

function updateTotal(){
    let total = cart.reduce((acc,item)=>acc + item.price*item.qty,0);
    document.getElementById('billing-total').innerText = `Total: ₹${total.toFixed(2)}`;
    localStorage.setItem('total', total.toFixed(2));
    localStorage.setItem('cart', JSON.stringify(cart));
}

function addQuantityListeners(){
    document.querySelectorAll('.qty-input').forEach(input=>{
        input.addEventListener('change', (e)=>{
            let index = e.target.getAttribute('data-index');
            let value = parseInt(e.target.value);
            if(value < 1) value = 1;
            cart[index].qty = value;
            e.target.value = value;
            e.target.parentElement.nextElementSibling.innerText = `₹${(cart[index].price*value).toFixed(2)}`;
            updateTotal();
        });
    });
}

// Handle form submission
document.getElementById('billingForm').addEventListener('submit', function(e){
    e.preventDefault();

    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const address = document.getElementById('address').value.trim();

    if(cart.length === 0){
        alert("Your cart is empty! Please add items before placing an order.");
        return;
    }

    // Save billing info and order to localStorage
    const total = localStorage.getItem('total');
    const orderDetails = {
        customer: { name, email, phone, address },
        items: cart,
        total: total
    };

    localStorage.setItem('last_order', JSON.stringify(orderDetails));

    // Clear cart data
    localStorage.removeItem('cart');
    localStorage.removeItem('total');

    // Redirect to success page
    window.location.href = "{% url 'order_success' %}";
});

document.addEventListener('DOMContentLoaded', loadCart);
</script>

</body>
</html>
